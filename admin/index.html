<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Nightmare Racing - Admin</title>
  
  <!-- Site Styles -->
  <link rel="stylesheet" href="../src/css/indexStyles.css">
  <link rel="stylesheet" href="../src/css/navStyles.css">
  <link rel="stylesheet" href="../src/css/footer.css">
  <link rel="stylesheet" href="styles.css">
  
  <!-- Auctus Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    /* Import Google Fonts to match main site */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');
    
    :root {
      /* Colors matching main site */
      --primary-black: #0a0a0a;
      --secondary-black: #1a1a1a;
      --accent-red: #e50000;
      --accent-red-hover: #ff1a1a;
      --pure-white: #ffffff;
      --light-gray: #f5f5f5;
      --medium-gray: #888;
      --dark-gray: #333;
      
      /* Gradients */
      --red-gradient: linear-gradient(135deg, #e50000, #ff4444);
      --dark-gradient: linear-gradient(135deg, #0a0a0a, #1a1a1a);
      
      /* Typography */
      --font-primary: 'Orbitron', monospace;
      --font-secondary: 'Rajdhani', sans-serif;
    }

    body {
      background: var(--primary-black);
      color: var(--pure-white);
      font-family: var(--font-secondary);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* Authentication Styles */
    .auth-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: var(--dark-gradient);
      text-align: center;
      padding: 20px;
      position: relative;
    }
    
    .auth-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('../assets/backgroundImage1.png') center/cover;
      opacity: 0.1;
      z-index: 0;
    }
    
    .auth-box {
      background: rgba(26, 26, 26, 0.95);
      border: 1px solid var(--dark-gray);
      border-radius: 20px;
      padding: 50px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }
    
    .auth-logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 25px auto;
      display: block;
      border-radius: 50%;
      border: 2px solid var(--accent-red);
      padding: 10px;
      background: rgba(229, 0, 0, 0.1);
    }
    
    .auth-title {
      color: var(--accent-red);
      font-family: var(--font-primary);
      font-size: 2.5rem;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-weight: 900;
      background: var(--red-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .auth-subtitle {
      color: var(--medium-gray);
      margin-bottom: 35px;
      font-size: 1.2rem;
      font-weight: 300;
    }
    
    .auth-button {
      background: var(--red-gradient);
      color: white;
      padding: 18px 35px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-family: var(--font-secondary);
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      margin: 12px 0;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      box-shadow: 0 8px 25px rgba(229, 0, 0, 0.3);
    }
    
    .auth-button:hover {
      background: linear-gradient(135deg, #ff1a1a, #e50000);
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(229, 0, 0, 0.4);
    }
    
    .auth-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .auth-button.secondary {
      background: transparent;
      border: 2px solid var(--accent-red);
      color: var(--accent-red);
    }
    
    .auth-button.secondary:hover {
      background: var(--accent-red);
      color: white;
    }
    
    .status-message {
      margin: 25px 0;
      padding: 15px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
    }
    
    .status-success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4caf50;
      color: #4caf50;
    }
    
    .status-error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }
    
    .status-info {
      background: rgba(33, 150, 243, 0.2);
      border: 1px solid #2196f3;
      color: #2196f3;
    }
    
    .hidden {
      display: none !important;
    }
    
    .spinner {
      border: 4px solid rgba(229, 0, 0, 0.3);
      border-radius: 50%;
      border-top: 4px solid var(--accent-red);
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 25px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .back-link {
      color: var(--accent-red);
      text-decoration: none;
      margin-top: 25px;
      display: inline-block;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .back-link:hover {
      color: var(--accent-red-hover);
      text-decoration: underline;
    }
    
    /* Admin Content Styles */
    .admin-content {
      display: none;
      min-height: 100vh;
      background: var(--primary-black);
    }
    
    .admin-content.show {
      display: block;
    }
    
    .admin-header {
      background: var(--red-gradient);
      color: white;
      padding: 30px 0;
      text-align: center;
      box-shadow: 0 4px 20px rgba(229, 0, 0, 0.3);
    }
    
    .admin-header h1 {
      font-family: var(--font-primary);
      font-size: 2.5rem;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .admin-header p {
      margin: 10px 0 0 0;
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .admin-nav {
      background: var(--secondary-black);
      padding: 20px 0;
      border-bottom: 1px solid var(--dark-gray);
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .admin-nav button {
      background: transparent;
      border: 2px solid var(--accent-red);
      color: var(--accent-red);
      padding: 12px 25px;
      margin: 0 10px;
      border-radius: 25px;
      cursor: pointer;
      font-family: var(--font-secondary);
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .admin-nav button:hover,
    .admin-nav button.active {
      background: var(--accent-red);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(229, 0, 0, 0.3);
    }
    
    .admin-main {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Card Styles */
    .admin-card {
      background: var(--secondary-black);
      border: 1px solid var(--dark-gray);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
    }
    
    .admin-card:hover {
      border-color: var(--accent-red);
      box-shadow: 0 12px 40px rgba(229, 0, 0, 0.2);
      transform: translateY(-5px);
    }
    
    .admin-card h2, .admin-card h3 {
      color: var(--accent-red);
      font-family: var(--font-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 25px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      color: var(--accent-red);
      margin-bottom: 8px;
      font-weight: 600;
      font-family: var(--font-secondary);
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 15px;
      background: var(--primary-black);
      border: 2px solid var(--dark-gray);
      border-radius: 10px;
      color: var(--pure-white);
      font-size: 1rem;
      font-family: var(--font-secondary);
      transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: var(--accent-red);
      outline: none;
      box-shadow: 0 0 15px rgba(229, 0, 0, 0.3);
      background: rgba(26, 26, 26, 0.8);
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* Image Upload Styles */
    .image-upload-area {
      border: 2px dashed var(--accent-red);
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      background: rgba(229, 0, 0, 0.05);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .image-upload-area:hover {
      background: rgba(229, 0, 0, 0.1);
      border-color: var(--accent-red-hover);
    }
    
    .image-upload-area.has-image {
      border: 2px solid var(--accent-red);
      background: rgba(229, 0, 0, 0.1);
    }
    
    .upload-placeholder {
      color: var(--medium-gray);
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    
    .upload-icon {
      font-size: 3rem;
      color: var(--accent-red);
      margin-bottom: 15px;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .hidden-input {
      display: none;
    }
    
    /* Checkbox Styles */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
    }
    
    .checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--accent-red);
    }
    
    .checkbox-wrapper label {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    /* Cars Grid */
    .cars-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }
    
    .car-card {
      background: var(--secondary-black);
      border: 1px solid var(--dark-gray);
      border-radius: 15px;
      padding: 25px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .car-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--red-gradient);
    }
    
    .car-card:hover {
      border-color: var(--accent-red);
      box-shadow: 0 8px 25px rgba(229, 0, 0, 0.2);
      transform: translateY(-5px);
    }
    
    .car-card h3 {
      color: var(--accent-red);
      font-family: var(--font-primary);
      margin: 0 0 15px 0;
      font-size: 1.4rem;
    }
    
    .car-card p {
      color: var(--pure-white);
      margin: 8px 0;
      font-size: 1rem;
    }
    
    .car-card .car-meta {
      color: var(--medium-gray);
      font-size: 0.9rem;
    }
    
    .car-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .car-actions button {
      background: transparent;
      border: 1px solid var(--medium-gray);
      color: var(--medium-gray);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-family: var(--font-secondary);
      font-weight: 500;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .car-actions button:hover {
      border-color: var(--accent-red);
      color: var(--accent-red);
      background: rgba(229, 0, 0, 0.1);
    }
    
    .car-actions button.danger:hover {
      border-color: #f44336;
      color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }
    
    /* Test Results */
    .test-results {
      background: var(--primary-black);
      border: 1px solid var(--dark-gray);
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .test-results pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    /* Responsive Design - Improved */
    @media (max-width: 1200px) {
      .admin-main {
        padding: 20px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }
    
    @media (max-width: 768px) {
      .admin-main {
        padding: 15px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .cars-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .admin-nav {
        padding: 15px 10px;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .admin-nav button {
        display: inline-block;
        margin: 0 5px;
        font-size: 0.9rem;
        padding: 10px 15px;
        min-width: 120px;
      }
      
      .admin-header h1 {
        font-size: 2rem;
      }
      
      .admin-header {
        padding: 20px 0;
      }
      
      .admin-card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .car-card {
        padding: 15px;
      }
      
      .auth-box {
        padding: 20px;
        margin: 10px;
        width: calc(100% - 20px);
      }
      
      .auth-title {
        font-size: 1.8rem;
      }
    }
    
    @media (max-width: 480px) {
      .admin-main {
        padding: 10px;
      }
      
      .admin-header h1 {
        font-size: 1.6rem;
        letter-spacing: 1px;
      }
      
      .admin-card {
        padding: 15px;
      }
      
      .form-group label {
        font-size: 0.9rem;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        font-size: 16px; /* Prevent zoom on iOS */
      }
      
      .auth-box {
        padding: 15px;
        margin: 5px;
        width: calc(100% - 10px);
      }
      
      .auth-title {
        font-size: 1.5rem;
      }
    }
    
    /* Loading States */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--accent-red);
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    /* Image Management Styles */
    .image-upload-area.has-image {
      position: relative;
    }
    
    .image-upload-area.has-image:hover .upload-overlay {
      opacity: 1 !important;
    }
    
    .upload-overlay button:hover {
      transform: scale(1.05);
      transition: transform 0.2s;
    }
    
  </style>
</head>
<body>
  <!-- Authentication Screen -->
  <div id="auth-screen" class="auth-container">
    <div class="auth-box">
      <img src="../assets/logoImage1.png" alt="Nightmare Racing" class="auth-logo">
      <h1 class="auth-title">Nightmare Racing</h1>
      <p class="auth-subtitle">Admin Portal</p>
      
      <!-- Initial Loading -->
      <div id="auth-loading">
        <div class="spinner"></div>
        <p>Loading authentication...</p>
        <button id="skip-auth-button" class="auth-button secondary" style="margin-top: 20px; display: none;">Skip Authentication (Debug)</button>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">
          Taking too long? <a href="#" id="force-login-link" style="color: #e50000;">Force login screen</a>
        </p>
      </div>
      
      <!-- Not Logged In -->
      <div id="auth-login" class="hidden">
        <p>Please log in to access the admin panel</p>
        <button id="login-button" class="auth-button">Login with Auctus</button>
        <button id="refresh-button" class="auth-button secondary">Refresh Page</button>
        <a href="../index.html" class="back-link">‚Üê Back to Website</a>
      </div>
      
      <!-- Setup Required -->
      <div id="auth-setup" class="hidden">
        <h3 style="color: #e50000;">Setup Required</h3>
        <p>Auctus Identity needs to be configured:</p>
        <ol style="text-align: left; color: #ccc;">
          <li>Enable Auctus Identity in your site settings</li>
          <li>Set registration to "Invite only"</li>
          <li>Enable Git Gateway</li>
          <li>Add your email as a user</li>
        </ol>
        <button id="retry-button" class="auth-button">Retry</button>
      </div>
      
      <!-- Status Messages -->
      <div id="status-message" class="status-message hidden"></div>
    </div>
  </div>

  <!-- Admin Content (shown after successful login) -->
  <div id="admin-content" class="admin-content">
    <div class="admin-header">
      <h1>Nightmare Racing Admin</h1>
      <p>Manage your cars and content</p>
    </div>
    
    <div class="admin-nav">
      <button id="nav-cars" class="active">üèéÔ∏è Manage Cars</button>
      <button id="nav-test">üîß Test Database</button>
      <button id="logout-button">Logout</button>
    </div>
    
    <div class="admin-main">
      <!-- Cars Management Section -->
      <div id="section-cars">
        <div class="admin-card">
          <h2>üèéÔ∏è Add New Car</h2>
          
          <form id="add-car-form">
            <!-- Basic Information -->
            <div class="form-grid">
              <div class="form-group">
                <label for="car-name">Car Name *</label>
                <input type="text" id="car-name" name="name" required placeholder="e.g., Twin-Turbo Supra">
              </div>
              
              <div class="form-group">
                <label for="car-status">Build Status</label>
                <select id="car-status" name="status">
                  <option value="COMPLETED">‚úÖ Completed</option>
                  <option value="IN PROGRESS">üîß In Progress</option>
                  <option value="FEATURED BUILD">‚≠ê Featured Build</option>
                  <option value="CUSTOMER CAR">üë§ Customer Car</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="car-description">Description *</label>
              <textarea id="car-description" name="description" required placeholder="e.g., 1200HP Beast ‚Ä¢ Custom Build ‚Ä¢ Track Ready" rows="3"></textarea>
            </div>
            
            <!-- Image Upload Section -->
            <div class="form-group">
              <label>Main Car Image</label>
              <div class="image-upload-area" id="main-image-upload">
                <input type="file" id="main-image-input" class="hidden-input" accept="image/*">
                <div class="upload-content">
                  <div class="upload-icon">üì∑</div>
                  <div class="upload-placeholder">Click to upload main car image</div>
                  <small style="color: var(--medium-gray);">Recommended: 1920x1080px, JPG or PNG</small>
                </div>
              </div>
              <input type="hidden" id="main-image-url" name="mainImage">
            </div>
            
            <!-- Gallery Upload Section -->
            <div class="form-group">
              <label>Gallery Images (Optional)</label>
              <div class="image-upload-area" id="gallery-upload">
                <input type="file" id="gallery-input" class="hidden-input" accept="image/*" multiple>
                <div class="upload-content">
                  <div class="upload-icon">üñºÔ∏è</div>
                  <div class="upload-placeholder">Click to upload gallery images</div>
                  <small style="color: var(--medium-gray);">Select multiple images for car gallery</small>
                </div>
              </div>
              <div id="gallery-preview" class="gallery-preview"></div>
              <input type="hidden" id="gallery-urls" name="gallery">
            </div>
            
            <!-- Featured Toggle -->
            <div class="checkbox-wrapper">
              <input type="checkbox" id="car-featured" name="featured" checked>
              <label for="car-featured">‚≠ê Feature this car on homepage</label>
            </div>

            <button type="submit" class="auth-button" style="margin-top: 20px;">
              üöó Add Car to Database
            </button>
          </form>
        </div>
        
        <!-- Cars List -->
        <div class="admin-card">
          <h2>üèÅ Current Cars</h2>
          <div id="cars-container">
            <div id="cars-list" class="cars-grid">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Database Test Section -->
      <div id="section-test" class="hidden">
        <div class="admin-card">
          <h2>üîß Database Connection Test</h2>
          <p style="color: var(--medium-gray); margin-bottom: 25px;">
            Test your database connection and API functionality to ensure everything is working properly.
          </p>
          
          <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;">
            <button id="test-connection" class="auth-button" style="flex: 1; min-width: 200px;">
              üîó Test API Connection
            </button>
            <button id="test-cars" class="auth-button" style="flex: 1; min-width: 200px;">
              üèéÔ∏è Load All Cars
            </button>
          </div>
          
          <div id="test-results" class="test-results hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Simple, reliable authentication system
    class AdminAuth {
      constructor() {
        this.user = null;
        this.initialized = false;
        this.setupElements();
        this.init();
      }
      
      setupElements() {
        // Auth elements
        this.authScreen = document.getElementById('auth-screen');
        this.authLoading = document.getElementById('auth-loading');
        this.authLogin = document.getElementById('auth-login');
        this.authSetup = document.getElementById('auth-setup');
        this.adminContent = document.getElementById('admin-content');
        this.statusMessage = document.getElementById('status-message');
        
        // Buttons
        this.loginButton = document.getElementById('login-button');
        this.refreshButton = document.getElementById('refresh-button');
        this.retryButton = document.getElementById('retry-button');
        this.logoutButton = document.getElementById('logout-button');
        
        // Bind events
        this.loginButton.addEventListener('click', () => this.login());
        this.refreshButton.addEventListener('click', () => window.location.reload());
        this.retryButton.addEventListener('click', () => this.init());
        this.logoutButton.addEventListener('click', () => this.logout());
        
        // Additional fallback buttons
        document.getElementById('skip-auth-button').addEventListener('click', () => this.skipAuth());
        document.getElementById('force-login-link').addEventListener('click', (e) => {
          e.preventDefault();
          this.showLogin();
        });
        
        // Show skip button after 5 seconds
        setTimeout(() => {
          const skipBtn = document.getElementById('skip-auth-button');
          if (skipBtn && !this.initialized) {
            skipBtn.style.display = 'block';
          }
        }, 5000);
      }
      
      async init() {
        console.log('üöÄ Initializing Nightmare Racing Admin...');
        this.showLoading();
        
        try {
          // Wait for Auctus Identity to load
          if (!window.netlifyIdentity) {
            await this.waitForAuctusIdentity();
          }
          
          // Set up event listeners first
          window.netlifyIdentity.on('init', (user) => {
            console.log('üîÑ Netlify Identity initialized');
            this.initialized = true;
            this.handleInit(user);
          });
          window.netlifyIdentity.on('login', (user) => this.handleLogin(user));
          window.netlifyIdentity.on('logout', () => this.handleLogout());
          window.netlifyIdentity.on('error', (err) => this.handleError(err));
          
          // Initialize Auctus Identity
          window.netlifyIdentity.init();
          
          // Add multiple timeouts to handle different scenarios
          setTimeout(() => {
            if (!this.initialized) {
              console.log('‚ö†Ô∏è Init event timeout, checking current user...');
              this.checkAndInitialize();
            }
          }, 2000); // First check at 2 seconds
          
          setTimeout(() => {
            if (!this.initialized) {
              console.log('‚ö†Ô∏è Second timeout, force checking current user...');
              this.checkAndInitialize();
            }
          }, 5000); // Second check at 5 seconds
          
          console.log('‚úÖ Authentication system setup complete');
          
        } catch (error) {
          console.error('‚ùå Failed to initialize:', error);
          this.showStatus('Failed to load authentication. Please refresh the page.', 'error');
          setTimeout(() => this.showLogin(), 2000);
        }
      }
      
      checkAndInitialize() {
        try {
          const currentUser = window.netlifyIdentity.currentUser();
          if (currentUser) {
            console.log('‚úÖ Found existing user:', currentUser.email);
            this.user = currentUser;
            this.initialized = true;
            this.showAdmin();
          } else {
            console.log('‚ÑπÔ∏è No current user, showing login');
            this.showLogin();
            this.initialized = true;
          }
        } catch (err) {
          console.error('‚ùå Error checking current user:', err);
          this.showLogin();
          this.initialized = true;
        }
      }
      
      waitForAuctusIdentity() {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const maxAttempts = 30; // 3 seconds
          
          const checkIdentity = () => {
            attempts++;
            console.log(`üîÑ Checking for Auctus Identity... (${attempts}/${maxAttempts})`);
            
            if (window.netlifyIdentity) {
              console.log('‚úÖ Auctus Identity loaded');
              resolve();
            } else if (attempts >= maxAttempts) {
              console.error('‚ùå Auctus Identity failed to load after 3 seconds');
              this.showStatus('Auctus Identity widget failed to load. Please check your internet connection and refresh.', 'error');
              setTimeout(() => this.showLogin(), 2000);
              reject(new Error('Auctus Identity failed to load'));
            } else {
              setTimeout(checkIdentity, 100);
            }
          };
          
          checkIdentity();
        });
      }
      
      handleInit(user) {
        if (user) {
          console.log('‚úÖ User already logged in:', user.email);
          this.user = user;
          this.showAdmin();
        } else {
          console.log('‚ÑπÔ∏è No user logged in');
          this.showLogin();
        }
      }
      
      handleLogin(user) {
        console.log('‚úÖ User logged in:', user.email);
        this.user = user;
        this.showStatus('Login successful!', 'success');
        setTimeout(() => this.showAdmin(), 1000);
      }
      
      handleLogout() {
        console.log('‚ÑπÔ∏è User logged out');
        this.user = null;
        this.initialized = false;
        // Reset admin content and show auth screen
        this.adminContent.classList.remove('show');
        this.authScreen.style.display = 'flex';
        this.showLogin();
        this.showStatus('Logged out successfully', 'info');
      }
      
      handleError(error) {
        console.error('‚ùå Authentication error:', error);
        if (error.message.includes('not enabled')) {
          this.showSetup();
        } else {
          this.showStatus('Authentication error: ' + error.message, 'error');
          this.showLogin();
        }
      }
      
      login() {
        console.log('üîÑ Opening Auctus login modal...');
        this.showStatus('Opening login...', 'info');
        try {
          window.netlifyIdentity.open();
        } catch (error) {
          console.error('‚ùå Failed to open login:', error);
          this.showStatus('Failed to open login. Try refreshing the page.', 'error');
        }
      }
      
      logout() {
        console.log('üîÑ Logging out...');
        this.showStatus('Logging out...', 'info');
        try {
          if (window.netlifyIdentity && this.user) {
            window.netlifyIdentity.logout();
          } else {
            // Force logout if no identity or user
            this.handleLogout();
          }
        } catch (error) {
          console.error('‚ùå Logout error:', error);
          // Force logout by clearing user and showing login
          this.user = null;
          this.showLogin();
          this.showStatus('Logged out (forced)', 'info');
        }
      }
      
      skipAuth() {
        console.log('‚ö†Ô∏è Skipping authentication (debug mode)');
        this.user = { email: 'debug@nightmareracing.com', user_metadata: { full_name: 'Debug User' } };
        this.showStatus('Authentication bypassed - Debug mode active', 'info');
        setTimeout(() => this.showAdmin(), 1000);
      }
      
      showLoading() {
        this.hideAll();
        this.authLoading.classList.remove('hidden');
      }
      
      showLogin() {
        this.hideAll();
        this.authLogin.classList.remove('hidden');
        this.authScreen.style.display = 'flex';
      }
      
      showSetup() {
        this.hideAll();
        this.authSetup.classList.remove('hidden');
        this.authScreen.style.display = 'flex';
      }
      
      showAdmin() {
        console.log('üöÄ Admin - Showing admin content');
        this.authScreen.style.display = 'none';
        this.adminContent.classList.add('show');
        // Initialize admin functionality
        if (window.adminApp) {
          console.log('üöÄ Admin - Calling adminApp.init()');
          window.adminApp.init();
        } else {
          console.warn('‚ö†Ô∏è Admin - adminApp not available, retrying...');
          // Retry after a short delay
          setTimeout(() => {
            if (window.adminApp) {
              console.log('üöÄ Admin - Retry successful, calling adminApp.init()');
              window.adminApp.init();
            } else {
              console.error('‚ùå Admin - adminApp still not available');
            }
          }, 500);
        }
      }
      
      hideAll() {
        this.authLoading.classList.add('hidden');
        this.authLogin.classList.add('hidden');
        this.authSetup.classList.add('hidden');
        this.statusMessage.classList.add('hidden');
      }
      
      showStatus(message, type = 'info') {
        this.statusMessage.textContent = message;
        this.statusMessage.className = `status-message status-${type}`;
        this.statusMessage.classList.remove('hidden');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          this.statusMessage.classList.add('hidden');
        }, 5000);
      }
    }
    
    // Admin functionality
    class AdminApp {
      constructor() {
        this.cars = [];
        this.setupNavigation();
        this.setupForms();
      }
      
      init() {
        console.log('üöÄ Initializing admin app...');
        this.loadCars();
      }
      
      setupNavigation() {
        document.getElementById('nav-cars').addEventListener('click', () => {
          this.showSection('cars');
          this.setActiveNav('nav-cars');
        });
        
        document.getElementById('nav-test').addEventListener('click', () => {
          this.showSection('test');
          this.setActiveNav('nav-test');
        });
        
        // Test buttons
        document.getElementById('test-connection').addEventListener('click', () => this.testConnection());
        document.getElementById('test-cars').addEventListener('click', () => this.testCars());
      }
      
      setupForms() {
        // Main form submission
        document.getElementById('add-car-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.addCar();
        });
        
        // Main image upload
        this.setupImageUpload('main-image-upload', 'main-image-input', 'main-image-url', false);
        
        // Gallery upload
        this.setupImageUpload('gallery-upload', 'gallery-input', 'gallery-urls', true);
      }
      
      setupImageUpload(uploadAreaId, inputId, urlFieldId, isMultiple) {
        const uploadArea = document.getElementById(uploadAreaId);
        const fileInput = document.getElementById(inputId);
        const urlField = document.getElementById(urlFieldId);
        
        // Click to trigger file selection
        uploadArea.addEventListener('click', () => {
          fileInput.click();
        });
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.style.background = 'rgba(229, 0, 0, 0.15)';
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
          e.preventDefault();
          uploadArea.style.background = 'rgba(229, 0, 0, 0.05)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.style.background = 'rgba(229, 0, 0, 0.05)';
          
          const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
          if (files.length > 0) {
            this.handleImageFiles(files, uploadArea, urlField, isMultiple);
          }
        });
        
        // File input change
        fileInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files);
          if (files.length > 0) {
            this.handleImageFiles(files, uploadArea, urlField, isMultiple);
          }
        });
      }
      
      handleImageFiles(files, uploadArea, urlField, isMultiple) {
        uploadArea.classList.add('has-image');
        
        if (isMultiple) {
          // Handle multiple images for gallery
          const galleryPreview = document.getElementById('gallery-preview');
          galleryPreview.innerHTML = '';
          
          const imageUrls = [];
          files.forEach((file, index) => {
            // Create a placeholder URL based on filename for demo purposes
            // In production, you'd upload to a service like Cloudinary, AWS S3, etc.
            const placeholderUrl = `https://via.placeholder.com/400x300/000000/e50000?text=Gallery+${index + 1}`;
            imageUrls.push(placeholderUrl);
            
            urlField.value = JSON.stringify(imageUrls);
            
            // Create preview
            const previewDiv = document.createElement('div');
            previewDiv.style.display = 'inline-block';
            previewDiv.style.margin = '10px';
            previewDiv.style.position = 'relative';
            
            const img = document.createElement('img');
            img.src = placeholderUrl;
            img.style.width = '120px';
            img.style.height = '80px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.border = '2px solid var(--accent-red)';
            
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '‚úï';
            removeBtn.style.position = 'absolute';
            removeBtn.style.top = '-8px';
            removeBtn.style.right = '-8px';
            removeBtn.style.background = 'var(--accent-red)';
            removeBtn.style.color = 'white';
            removeBtn.style.border = 'none';
            removeBtn.style.borderRadius = '50%';
            removeBtn.style.width = '20px';
            removeBtn.style.height = '20px';
            removeBtn.style.cursor = 'pointer';
            removeBtn.style.fontSize = '12px';
            
            removeBtn.onclick = () => {
              previewDiv.remove();
              // Update URL field by removing this image
              const currentUrls = JSON.parse(urlField.value || '[]');
              const newUrls = currentUrls.filter((_, i) => i !== index);
              urlField.value = JSON.stringify(newUrls);
            };
            
            previewDiv.appendChild(img);
            previewDiv.appendChild(removeBtn);
            galleryPreview.appendChild(previewDiv);
          });
          
          uploadArea.innerHTML = `
            <div style="color: var(--accent-red); font-weight: bold;">
              üì∑ ${files.length} image(s) selected for gallery (demo placeholders)
            </div>
          `;
        } else {
          // Handle single main image
          const file = files[0];
          // Create a placeholder URL for demo purposes
          const placeholderUrl = `https://via.placeholder.com/800x400/000000/e50000?text=Main+Image`;
          
          urlField.value = placeholderUrl;
          
          uploadArea.innerHTML = `
            <img src="${placeholderUrl}" class="image-preview" style="max-width: 100%; max-height: 200px; border-radius: 10px;">
            <div style="margin-top: 10px; color: var(--accent-red); font-weight: bold;">
              üì∑ Main image uploaded: ${file.name} (demo placeholder)
            </div>
          `;
        }
      }
      
      showSection(section) {
        document.getElementById('section-cars').classList.add('hidden');
        document.getElementById('section-test').classList.add('hidden');
        document.getElementById(`section-${section}`).classList.remove('hidden');
      }
      
      setActiveNav(activeId) {
        document.querySelectorAll('.admin-nav button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(activeId).classList.add('active');
      }
      
      async loadCars() {
        try {
          const response = await fetch('/.netlify/functions/api-cars');
          
          if (response.ok) {
            this.cars = await response.json();
            if (Array.isArray(this.cars) && this.cars.length > 0) {
              this.renderCars();
              return;
            }
          } else {
            console.warn(`‚ùå Admin - API error (${response.status}): ${response.statusText}`);
          }
        } catch (error) {
          console.error('‚ùå Admin - Failed to load from database:', error);
        }
        
        // Try to use carousel data as fallback
        if (window.carsData && window.carsData.length > 0) {
          console.log('üîÑ Admin - Using carousel data as fallback');
          this.cars = window.carsData;
          console.log(`‚úÖ Admin - Loaded ${this.cars.length} cars from carousel fallback`);
          this.renderCars();
          return;
        }
        
        // Last resort - use default demo data
        console.log('üîÑ Admin - Using demo data as final fallback');
        this.cars = this.getDefaultCars();
        console.log(`‚úÖ Admin - Loaded ${this.cars.length} demo cars`);
        this.renderCars();
        
        // Show helpful message about the fallback data
        const container = document.getElementById('cars-list');
        if (container && this.cars.length > 0) {
          const warningDiv = document.createElement('div');
          warningDiv.style.cssText = 'background: rgba(255,165,0,0.1); border: 2px solid orange; padding: 15px; margin-bottom: 20px; border-radius: 10px; text-align: center;';
          warningDiv.innerHTML = `
            <h3 style="color: orange; margin: 0 0 10px 0;">‚ö†Ô∏è Using Demo Data</h3>
            <p style="margin: 0; color: white;">Database connection failed. Showing demo cars for testing purposes.</p>
          `;
          container.insertBefore(warningDiv, container.firstChild);
        }
      }
      
      renderCars() {
        const container = document.getElementById('cars-list');
        
        if (this.cars.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--medium-gray); grid-column: 1 / -1;">
              <div style="font-size: 4rem; margin-bottom: 20px;">üèéÔ∏è</div>
              <h3 style="color: var(--accent-red); margin-bottom: 10px;">No Cars Yet</h3>
              <p>Add your first car using the form above to get started!</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = this.cars.map(car => {
          const hasImage = car.mainImage && car.mainImage !== 'null';
          const hasGallery = car.gallery && car.gallery.length > 0;
          
          return `
            <div class="car-card">
              ${hasImage ? `
                <div style="margin-bottom: 15px;">
                  <img src="${car.mainImage}" 
                       style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px; border: 2px solid var(--accent-red);" 
                       alt="${car.name}"
                       onerror="this.style.display='none'">
                </div>
              ` : ''}
              
              <h3>${car.name}</h3>
              <p style="color: var(--pure-white); font-size: 1rem; margin-bottom: 15px;">
                ${car.description || 'No description'}
              </p>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <p class="car-meta"><strong>Status:</strong> ${this.getStatusEmoji(car.status)} ${car.status}</p>
                <p class="car-meta"><strong>Featured:</strong> ${car.featured ? '‚≠ê Yes' : '‚ùå No'}</p>
              </div>
              
              ${hasGallery ? `
                <div style="margin-bottom: 15px;">
                  <h4 style="color: var(--accent-red); margin: 0 0 8px 0; font-size: 0.9rem;">üì∏ GALLERY (${car.gallery.length})</h4>
                  <div style="display: flex; gap: 5px; overflow-x: auto;">
                    ${car.gallery.slice(0, 4).map(img => `
                      <img src="${img}" 
                           style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid var(--accent-red);" 
                           onerror="this.style.display='none'">
                    `).join('')}
                    ${car.gallery.length > 4 ? `<span style="color: var(--medium-gray); font-size: 0.8rem; align-self: center;">+${car.gallery.length - 4} more</span>` : ''}
                  </div>
                </div>
              ` : ''}
              
              <div style="font-size: 0.8rem; color: var(--medium-gray); margin-bottom: 15px;">
                Added: ${new Date(car.dateAdded || car.created_at).toLocaleDateString()}
              </div>
              
              <div class="car-actions">
                <button onclick="if(window.adminApp) { window.adminApp.editCar(${car.id}); } else { console.error('adminApp not available'); }" title="Edit car details">
                  ‚úèÔ∏è Edit
                </button>
                <button onclick="if(window.adminApp) { window.adminApp.deleteCar(${car.id}); } else { console.error('adminApp not available'); }" class="danger" title="Delete car">
                  üóëÔ∏è Delete
                </button>
                <button onclick="if(window.adminApp) { window.adminApp.viewCar(${car.id}); } else { console.error('adminApp not available'); }" title="View full details">
                  üëÅÔ∏è View
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      getStatusEmoji(status) {
        switch(status) {
          case 'COMPLETED': return '‚úÖ';
          case 'IN PROGRESS': return 'üîß';
          case 'FEATURED BUILD': return '‚≠ê';
          case 'CUSTOMER CAR': return 'üë§';
          default: return 'üèéÔ∏è';
        }
      }
      
      viewCar(carId) {
        const car = this.cars.find(c => c.id === carId);
        if (!car) return;
        
        // Create a modal or detailed view
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;
          background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center;
          padding: 20px; cursor: pointer;
        `;
        
        modal.innerHTML = `
          <div style="background: var(--secondary-black); border-radius: 15px; padding: 30px; max-width: 800px; max-height: 90vh; overflow-y: auto; cursor: default;" onclick="event.stopPropagation()">
            <h2 style="color: var(--accent-red); margin-top: 0;">${car.name}</h2>
            ${car.mainImage ? `<img src="${car.mainImage}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 10px; margin-bottom: 20px;">` : ''}
            <p><strong>Description:</strong> ${car.description}</p>
            <p><strong>Status:</strong> ${car.status}</p>
            <p><strong>Featured:</strong> ${car.featured ? 'Yes' : 'No'}</p>
            <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 10px 20px; background: var(--accent-red); color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
          </div>
        `;
        
        modal.onclick = () => modal.remove();
        document.body.appendChild(modal);
      }
      
      async addCar() {
        const form = document.getElementById('add-car-form');
        const formData = new FormData(form);
        
        // Get gallery images
        const galleryUrls = document.getElementById('gallery-urls').value;
        const gallery = galleryUrls ? JSON.parse(galleryUrls) : [];
        
        const carData = {
          name: formData.get('name'),
          description: formData.get('description'),
          status: formData.get('status'),
          featured: formData.has('featured'),
          mainImage: formData.get('mainImage') || null,
          gallery: gallery
        };
        
        try {
          const isEditing = this.editingCarId;
          const actionText = isEditing ? 'Updating' : 'Adding';
          console.log(`üîÑ ${actionText} car...`, carData);
          
          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = `‚è≥ ${actionText} Car...`;
          submitBtn.disabled = true;
          
          let response;
          if (isEditing) {
            // Update existing car
            response = await fetch(`/.netlify/functions/api-cars/${this.editingCarId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(carData)
            });
          } else {
            // Add new car
            response = await fetch('/.netlify/functions/api-cars', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(carData)
            });
          }
          
          if (response.ok) {
            console.log(`‚úÖ Car ${isEditing ? 'updated' : 'added'} successfully`);
            
            // Reset form
            form.reset();
            document.getElementById('car-featured').checked = true;
            
            // Reset image uploads
            this.resetImageUploads();
            
            // If editing, cancel edit mode
            if (isEditing) {
              this.cancelEdit();
            }
            
            // Reload list
            this.loadCars();
            
            // Show success message
            this.showNotification(`Car ${isEditing ? 'updated' : 'added'} successfully! üéâ`, 'success');
            
          } else {
            throw new Error(`Failed to ${isEditing ? 'update' : 'add'} car: ${response.status}`);
          }
          
          // Reset button
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
          
        } catch (error) {
          const action = this.editingCarId ? 'update' : 'add';
          console.error(`‚ùå Failed to ${action} car:`, error);
          this.showMessage(`Failed to ${action} car: ` + error.message, 'error');
          
          // Reset button
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.innerHTML = this.editingCarId ? 'üìù Update Car' : 'üöó Add Car to Database';
          submitBtn.disabled = false;
        }
      }
      
      resetImageUploads() {
        // Reset main image upload
        const mainUpload = document.getElementById('main-image-upload');
        mainUpload.classList.remove('has-image');
        mainUpload.innerHTML = `
          <div class="upload-content">
            <div class="upload-icon">üì∑</div>
            <div class="upload-placeholder">Click to upload main car image</div>
            <small style="color: var(--medium-gray);">Recommended: 1920x1080px, JPG or PNG</small>
          </div>
        `;
        document.getElementById('main-image-url').value = '';
        
        // Reset gallery upload
        const galleryUpload = document.getElementById('gallery-upload');
        galleryUpload.classList.remove('has-image');
        galleryUpload.innerHTML = `
          <div class="upload-content">
            <div class="upload-icon">üñºÔ∏è</div>
            <div class="upload-placeholder">Click to upload gallery images</div>
            <small style="color: var(--medium-gray);">Select multiple images for car gallery</small>
          </div>
        `;
        document.getElementById('gallery-preview').innerHTML = '';
        document.getElementById('gallery-urls').value = '';
      }
      
      showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `status-message status-${type}`;
        notification.textContent = message;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '10000';
        notification.style.maxWidth = '400px';
        
        document.body.appendChild(notification);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
          notification.remove();
        }, 4000);
      }
      
      async deleteCar(carId) {
        if (!confirm('Are you sure you want to delete this car?')) return;
        
        try {
          console.log('üîÑ Deleting car:', carId);
          const response = await fetch(`/.netlify/functions/api-cars/${carId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            console.log('‚úÖ Car deleted successfully');
            this.loadCars(); // Reload list
          } else {
            throw new Error(`Failed to delete car: ${response.status}`);
          }
        } catch (error) {
          console.error('‚ùå Failed to delete car:', error);
          alert('Failed to delete car: ' + error.message);
        }
      }
      
      editCar(carId) {
        console.log('üîÑ Admin - Editing car:', carId);
        const car = this.cars.find(c => c.id === carId);
        if (!car) {
          console.error('‚ùå Admin - Car not found:', carId);
          return;
        }
        
        console.log('üìù Admin - Car data:', car);
        
        // Populate the form with existing data
        document.getElementById('car-name').value = car.name || '';
        document.getElementById('car-description').value = car.description || '';
        document.getElementById('car-status').value = car.status || 'IN PROGRESS';
        document.getElementById('car-featured').checked = car.featured || false;
        
        // Handle existing main image
        if (car.mainImage && car.mainImage !== 'null') {
          document.getElementById('main-image-url').value = car.mainImage;
          const mainImageUpload = document.getElementById('main-image-upload');
          mainImageUpload.classList.add('has-image');
          mainImageUpload.innerHTML = `
            <img src="${car.mainImage}" class="image-preview" style="max-width: 100%; max-height: 200px; border-radius: 10px;">
            <div class="upload-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; border-radius: 10px;">
              <button type="button" class="change-image-btn" onclick="document.getElementById('main-image-input').click()" style="background: var(--accent-red); color: white; border: none; padding: 8px 16px; margin: 4px; border-radius: 6px; cursor: pointer; font-size: 14px;">üì∑ Change Image</button>
              <button type="button" class="remove-image-btn" onclick="window.adminApp.removeMainImage()" style="background: #666; color: white; border: none; padding: 8px 16px; margin: 4px; border-radius: 6px; cursor: pointer; font-size: 14px;">üóëÔ∏è Remove</button>
            </div>
          `;
        }
        
        // Handle existing gallery images
        if (car.gallery && car.gallery.length > 0) {
          const galleryUrls = car.gallery.map(img => typeof img === 'string' ? img : img.url).filter(url => url && url !== 'null');
          document.getElementById('gallery-urls').value = JSON.stringify(galleryUrls);
          
          const galleryPreview = document.getElementById('gallery-preview');
          galleryPreview.innerHTML = galleryUrls.map((url, index) => `
            <div class="gallery-item" style="position: relative; display: inline-block; margin: 5px;">
              <img src="${url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;">
              <button type="button" class="remove-gallery-btn" onclick="window.adminApp.removeGalleryImage(${index})" 
                      style="position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">‚úï</button>
            </div>
          `).join('');
        }
        
        // Store editing car ID
        this.editingCarId = carId;
        
        // Update button text
        const submitBtn = document.querySelector('#add-car-form button[type="submit"]');
        submitBtn.textContent = 'üìù Update Car';
        submitBtn.style.background = 'linear-gradient(45deg, #ff4444, #cc0000)';
        
        // Add cancel button if not exists
        if (!document.getElementById('cancel-edit-btn')) {
          const cancelBtn = document.createElement('button');
          cancelBtn.id = 'cancel-edit-btn';
          cancelBtn.type = 'button';
          cancelBtn.textContent = '‚ùå Cancel Edit';
          cancelBtn.style.cssText = `
            background: var(--dark-gray); color: white; border: none; padding: 12px 24px; 
            border-radius: 8px; cursor: pointer; margin-left: 10px; font-family: 'Orbitron', sans-serif;
          `;
          cancelBtn.onclick = () => this.cancelEdit();
          submitBtn.parentNode.appendChild(cancelBtn);
        }
        
        // Scroll to form
        document.getElementById('add-car-form').scrollIntoView({ behavior: 'smooth' });
        
        this.showMessage(`‚úèÔ∏è Editing: ${car.name}`, 'info');
      }
      
      cancelEdit() {
        console.log('üîÑ Admin - Cancelling edit');
        this.editingCarId = null;
        
        // Reset form
        document.getElementById('add-car-form').reset();
        
        // Reset image uploads
        this.resetImageUploads();
        
        // Reset button
        const submitBtn = document.querySelector('#add-car-form button[type="submit"]');
        submitBtn.textContent = 'üöó Add Car to Database';
        submitBtn.style.background = 'linear-gradient(45deg, var(--accent-red), #cc0000)';
        
        // Remove cancel button
        const cancelBtn = document.getElementById('cancel-edit-btn');
        if (cancelBtn) cancelBtn.remove();
        
        this.showMessage('Edit cancelled', 'info');
      }
      
      async updateCar(carId, updates) {
        try {
          console.log('üîÑ Updating car:', carId, updates);
          const response = await fetch(`/.netlify/functions/api-cars/${carId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
          });
          
          if (response.ok) {
            console.log('‚úÖ Car updated successfully');
            this.loadCars(); // Reload list
          } else {
            throw new Error(`Failed to update car: ${response.status}`);
          }
        } catch (error) {
          console.error('‚ùå Failed to update car:', error);
          alert('Failed to update car: ' + error.message);
        }
      }
      
      async testConnection() {
        const results = document.getElementById('test-results');
        results.innerHTML = '<div class="spinner"></div><p>Testing connection...</p>';
        
        try {
          const response = await fetch('/.netlify/functions/api-cars');
          if (response.ok) {
            results.innerHTML = '<p style="color: #00ff00;">‚úÖ API connection successful!</p>';
          } else {
            results.innerHTML = `<p style="color: #ff0000;">‚ùå API error: ${response.status}</p>`;
          }
        } catch (error) {
          results.innerHTML = `<p style="color: #ff0000;">‚ùå Connection failed: ${error.message}</p>`;
        }
      }
      
      async testCars() {
        const results = document.getElementById('test-results');
        results.innerHTML = '<div class="spinner"></div><p>Loading cars...</p>';
        
        try {
          const response = await fetch('/.netlify/functions/api-cars');
          if (response.ok) {
            const cars = await response.json();
            results.innerHTML = `
              <p style="color: #00ff00;">‚úÖ Found ${cars.length} cars in database</p>
              <pre style="background: #1a1a1a; padding: 10px; border-radius: 5px; overflow-x: auto;">
${JSON.stringify(cars, null, 2)}
              </pre>
            `;
          } else {
            results.innerHTML = `<p style="color: #ff0000;">‚ùå Failed to load cars: ${response.status}</p>`;
          }
        } catch (error) {
          results.innerHTML = `<p style="color: #ff0000;">‚ùå Error: ${error.message}</p>`;
        }
      }
      
      showMessage(message, type = 'info') {
        console.log(`üìù Admin Message (${type}):`, message);
        
        // Create or update a message element
        let messageEl = document.getElementById('admin-message');
        if (!messageEl) {
          messageEl = document.createElement('div');
          messageEl.id = 'admin-message';
          messageEl.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            padding: 12px 24px; border-radius: 8px; font-weight: 500;
            max-width: 300px; word-wrap: break-word;
            transition: all 0.3s ease; transform: translateX(100%);
          `;
          document.body.appendChild(messageEl);
        }
        
        // Set message and style based on type
        messageEl.textContent = message;
        messageEl.className = '';
        
        if (type === 'error') {
          messageEl.style.cssText += `
            background: var(--accent-red); color: white;
            border: 2px solid #cc0000;
          `;
        } else if (type === 'success') {
          messageEl.style.cssText += `
            background: #00aa00; color: white;
            border: 2px solid #008800;
          `;
        } else {
          messageEl.style.cssText += `
            background: var(--secondary-black); color: var(--pure-white);
            border: 2px solid var(--accent-red);
          `;
        }
        
        // Show message
        setTimeout(() => {
          messageEl.style.transform = 'translateX(0)';
        }, 100);
        
        // Hide message after 4 seconds
        setTimeout(() => {
          messageEl.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (messageEl.parentNode) {
              messageEl.parentNode.removeChild(messageEl);
            }
          }, 300);
        }, 4000);
      }
      
      removeMainImage() {
        console.log('üóëÔ∏è Removing main image');
        
        // Clear the image URL input
        document.getElementById('main-image-url').value = '';
        
        // Reset the upload area
        const mainImageUpload = document.getElementById('main-image-upload');
        mainImageUpload.classList.remove('has-image');
        mainImageUpload.innerHTML = `
          <input type="file" id="main-image-input" class="hidden-input" accept="image/*">
          <div class="upload-content">
            <div class="upload-icon">üì∑</div>
            <div class="upload-placeholder">Click to upload main car image</div>
            <small style="color: var(--medium-gray);">Recommended: 1920x1080px, JPG or PNG</small>
          </div>
        `;
        
        // Re-attach the file input event listener
        this.setupImageUploads();
        
        this.showMessage('Main image removed', 'info');
      }
      
      removeGalleryImage(index) {
        console.log(`üóëÔ∏è Removing gallery image at index ${index}`);
        
        // Get current gallery URLs
        const galleryUrls = document.getElementById('gallery-urls').value;
        let gallery = galleryUrls ? JSON.parse(galleryUrls) : [];
        
        // Remove the image at the specified index
        gallery.splice(index, 1);
        
        // Update the hidden input
        document.getElementById('gallery-urls').value = JSON.stringify(gallery);
        
        // Update the preview
        const galleryPreview = document.getElementById('gallery-preview');
        galleryPreview.innerHTML = gallery.map((url, i) => `
          <div class="gallery-item" style="position: relative; display: inline-block; margin: 5px;">
            <img src="${url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;">
            <button type="button" class="remove-gallery-btn" onclick="window.adminApp.removeGalleryImage(${i})" 
                    style="position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">‚úï</button>
          </div>
        `).join('');
        
        this.showMessage('Gallery image removed', 'info');
      }
      
      setupImageUploads() {
        // Re-setup image upload handlers
        this.setupImageUpload('main-image-upload', 'main-image-input', 'main-image-url', false);
        this.setupImageUpload('gallery-upload', 'gallery-input', 'gallery-urls', true);
      }
    }
    
    // Initialize everything when page loads
    let auth, adminApp;

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Starting Nightmare Racing Admin...');
      auth = new AdminAuth();
      adminApp = new AdminApp();
      // Make adminApp globally available for onclick handlers
      window.adminApp = adminApp;
    });
  </script>
</body>
</html>