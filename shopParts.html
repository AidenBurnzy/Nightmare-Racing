<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Parts | Nightmare Racing</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="indexStyles.css">
    <link rel="stylesheet" href="navStyles.css">
    <link rel="stylesheet" href="shopParts.css">
    <link rel="stylesheet" href="footer.css">
</head>
<body>
    <!-- Video Background -->
    <video autoplay muted loop playsinline preload="auto" id="bg-video"
        style="position: fixed; right: 0; bottom: 0; min-width: 100vw; min-height: 100vh; z-index: -1; object-fit: cover; pointer-events: none; opacity: 0.3;">
        <source src="bg-video.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html"><img src="pictures/logoImage1.png" alt="Nightmare Racing Logo"></a>
                <h2>NIGHTMARE<span class="text-accent">RACING</span></h2>
            </div>

            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#services">Services</a></li>
                <li><a href="featured-cars.html">Featured Cars</a></li>
                <li><a href="shopParts.html" class="active">Shop Parts</a></li>
                <li><a href="index.html#contact">Contact</a></li>
            </ul>

            <div class="nav-actions">
                <a href="/admin" target="_blank" class="admin-btn">Admin</a>
            </div>

            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay"></div>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="mobile-menu-content">
            <div class="mobile-menu-header">
                <h2>NIGHTMARE<span class="text-accent">RACING</span></h2>
                <button class="mobile-menu-close">&times;</button>
            </div>

            <ul class="mobile-nav-links">
                <li><a href="/admin" target="_blank">Admin Portal</a></li>
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#services">Services</a></li>
                <li><a href="featured-cars.html">Featured Cars</a></li>
                <li><a href="shopParts.html" class="active">Shop Parts</a></li>
                <li><a href="index.html#contact">Contact</a></li>
            </ul>

            <div class="mobile-menu-footer">
                <p>Â© 2025 Nightmare Racing</p>
                <p>Premium Auto Services</p>
            </div>
        </div>
    </div>

    <!-- Shop Parts Page -->
    <section class="shop-parts-page">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>SHOP <span class="text-accent">PARTS</span></h1>
                <p>Premium performance parts and racing merchandise</p>
            </div>

            <!-- Search Bar -->
            <div class="search-section">
                <div class="search-bar">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="product-search" placeholder="Search for parts...">
                    <button class="search-btn" id="search-btn">Search</button>
                </div>
                <div id="search-results" class="search-results hidden"></div>
            </div>

            <!-- Collections Carousel -->
            <div class="collections-section">
                <div class="section-header">
                    <h2>SHOP BY <span class="text-accent">COLLECTION</span></h2>
                    <p>Browse our curated collections of performance parts</p>
                </div>

                <!-- Loading State -->
                <div id="collections-loading" class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading collections...</p>
                </div>

                <!-- Collections Carousel -->
                <div id="collections-carousel" class="collections-carousel hidden">
                    <button class="carousel-btn carousel-prev" id="collections-prev">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </button>
                    
                    <div class="carousel-track-container">
                        <div class="carousel-track" id="collections-track">
                            <!-- Collections will be loaded here -->
                        </div>
                    </div>

                    <button class="carousel-btn carousel-next" id="collections-next">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </button>
                </div>

                <!-- Carousel Indicators -->
                <div class="carousel-indicators" id="carousel-indicators"></div>
            </div>

            <!-- Featured Products -->
            <div class="products-section">
                <div class="section-header">
                    <h2>FEATURED <span class="text-accent">PRODUCTS</span></h2>
                    <p>Our most popular performance parts</p>
                </div>

                <!-- Loading State -->
                <div id="products-loading" class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading products...</p>
                </div>

                <!-- Products Grid -->
                <div id="products-grid" class="products-grid hidden">
                    <!-- Products will be loaded here -->
                </div>

                <!-- Load More Button -->
                <div class="load-more-section hidden" id="load-more-section">
                    <button class="btn-primary" id="load-more-btn">Load More Products</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <div id="footer-section"></div>

    <!-- Load Footer -->
    <script>
        async function loadFooter() {
            try {
                const response = await fetch('footer.html');
                const html = await response.text();
                document.getElementById('footer-section').innerHTML = html;
            } catch (error) {
                console.error('Error loading footer:', error);
            }
        }
        loadFooter();
    </script>

    <!-- Scripts -->
    <script src="index.js"></script>
    <script>
        // Shopify Storefront API Configuration
        const SHOPIFY_DOMAIN = 'nightmareracing.myshopify.com';
        const STOREFRONT_ACCESS_TOKEN = '01ebdb40d541cc7fda967406889dc1b4';
        const STOREFRONT_API_VERSION = '2024-01';

        // GraphQL query for collections
        const COLLECTIONS_QUERY = `
        {
            collections(first: 10) {
                edges {
                    node {
                        id
                        title
                        description
                        handle
                        image {
                            url
                            altText
                        }
                        products(first: 4) {
                            edges {
                                node {
                                    id
                                    title
                                    priceRange {
                                        minVariantPrice {
                                            amount
                                            currencyCode
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }`;

        // GraphQL query for products
        const PRODUCTS_QUERY = `
        query GetProducts($first: Int!, $after: String) {
            products(first: $first, after: $after) {
                pageInfo {
                    hasNextPage
                    endCursor
                }
                edges {
                    node {
                        id
                        title
                        description
                        handle
                        priceRange {
                            minVariantPrice {
                                amount
                                currencyCode
                            }
                        }
                        images(first: 1) {
                            edges {
                                node {
                                    url
                                    altText
                                }
                            }
                        }
                        variants(first: 1) {
                            edges {
                                node {
                                    id
                                    availableForSale
                                }
                            }
                        }
                    }
                }
            }
        }`;

        // Search products query
        const SEARCH_QUERY = `
        query SearchProducts($query: String!, $first: Int!) {
            products(first: $first, query: $query) {
                edges {
                    node {
                        id
                        title
                        handle
                        priceRange {
                            minVariantPrice {
                                amount
                                currencyCode
                            }
                        }
                        images(first: 1) {
                            edges {
                                node {
                                    url
                                    altText
                                }
                            }
                        }
                    }
                }
            }
        }`;

        // API call function
        async function shopifyStorefrontAPI(query, variables = {}) {
            const response = await fetch(`https://${SHOPIFY_DOMAIN}/api/${STOREFRONT_API_VERSION}/graphql.json`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Shopify-Storefront-Access-Token': STOREFRONT_ACCESS_TOKEN
                },
                body: JSON.stringify({ query, variables })
            });

            const data = await response.json();
            
            if (data.errors) {
                console.error('Shopify API Error:', data.errors);
                throw new Error(data.errors[0].message);
            }

            return data.data;
        }

        // Format price
        function formatPrice(amount, currencyCode) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currencyCode
            }).format(amount);
        }

        // Load collections
        let collectionsData = [];
        let currentCollectionIndex = 0;

        async function loadCollections() {
    try {
        const data = await shopifyStorefrontAPI(COLLECTIONS_QUERY);
        
        // Filter out unwanted collections by handle
        const excludedCollections = [
            'https://admin.shopify.com/store/nightmareracing/collections/317123887244',
            'https://admin.shopify.com/store/nightmareracing/collections/317568385164',
            'https://admin.shopify.com/store/nightmareracing/collections/317047013516',
            'https://admin.shopify.com/store/nightmareracing/collections/287569182860',
            'https://admin.shopify.com/store/nightmareracing/collections/287458984076',
            'https://admin.shopify.com/store/nightmareracing/collections/302260158604',
            'https://admin.shopify.com/store/nightmareracing/collections/287569182860',
            'frontpage' // example: hide frontpage collection
        ];
        
        collectionsData = data.collections.edges
            .map(edge => edge.node)
            .filter(collection => !excludedCollections.includes(collection.handle));
                
                if (collectionsData.length === 0) {
                    document.getElementById('collections-loading').innerHTML = '<p>No collections found</p>';
                    return;
                }

                displayCollections();
                document.getElementById('collections-loading').classList.add('hidden');
                document.getElementById('collections-carousel').classList.remove('hidden');
                setupCollectionsCarousel();
            } catch (error) {
                console.error('Error loading collections:', error);
                document.getElementById('collections-loading').innerHTML = 
                    '<p class="error">Failed to load collections. Please try again later.</p>';
            }
        }

        function displayCollections() {
            const track = document.getElementById('collections-track');
            track.innerHTML = '';

            collectionsData.forEach(collection => {
                const card = createCollectionCard(collection);
                track.appendChild(card);
            });

            updateCarouselIndicators();
        }

        function createCollectionCard(collection) {
            const card = document.createElement('div');
            card.className = 'collection-card';
            
            const imageUrl = collection.image?.url || 'https://via.placeholder.com/400x300/0a0a0a/e50000?text=No+Image';
            const productCount = collection.products.edges.length;
            
            card.innerHTML = `
                <div class="collection-image" style="background-image: url('${imageUrl}')">
                    <div class="collection-overlay">
                        <button class="btn-view-collection" onclick="viewCollection('${collection.handle}')">
                            View Collection
                        </button>
                    </div>
                </div>
                <div class="collection-info">
                    <h3>${collection.title}</h3>
                    <p>${collection.description || 'Explore our selection'}</p>
                    <span class="product-count">${productCount} product${productCount !== 1 ? 's' : ''}</span>
                </div>
            `;

            return card;
        }

        function setupCollectionsCarousel() {
            const prevBtn = document.getElementById('collections-prev');
            const nextBtn = document.getElementById('collections-next');
            
            prevBtn.addEventListener('click', () => moveCarousel(-1));
            nextBtn.addEventListener('click', () => moveCarousel(1));

            updateCarouselButtons();
        }

        function moveCarousel(direction) {
            const maxIndex = Math.max(0, collectionsData.length - 3);
            currentCollectionIndex = Math.max(0, Math.min(maxIndex, currentCollectionIndex + direction));
            
            const track = document.getElementById('collections-track');
            const offset = currentCollectionIndex * -340; // card width + gap
            track.style.transform = `translateX(${offset}px)`;
            
            updateCarouselButtons();
            updateCarouselIndicators();
        }

        function updateCarouselButtons() {
            const prevBtn = document.getElementById('collections-prev');
            const nextBtn = document.getElementById('collections-next');
            
            prevBtn.disabled = currentCollectionIndex === 0;
            nextBtn.disabled = currentCollectionIndex >= collectionsData.length - 3;
        }

        function updateCarouselIndicators() {
            const indicators = document.getElementById('carousel-indicators');
            const totalDots = Math.max(1, collectionsData.length - 2);
            
            indicators.innerHTML = '';
            for (let i = 0; i < totalDots; i++) {
                const dot = document.createElement('div');
                dot.className = `indicator-dot ${i === currentCollectionIndex ? 'active' : ''}`;
                dot.addEventListener('click', () => {
                    currentCollectionIndex = i;
                    moveCarousel(0);
                });
                indicators.appendChild(dot);
            }
        }

        // Load products
        let productsData = [];
        let productsEndCursor = null;
        let hasNextPage = false;

        async function loadProducts(loadMore = false) {
            try {
                const variables = {
                    first: 12,
                    after: loadMore ? productsEndCursor : null
                };

                const data = await shopifyStorefrontAPI(PRODUCTS_QUERY, variables);
                
                if (!loadMore) {
                    productsData = [];
                }

                productsData.push(...data.products.edges.map(edge => edge.node));
                productsEndCursor = data.products.pageInfo.endCursor;
                hasNextPage = data.products.pageInfo.hasNextPage;

                displayProducts();
                
                document.getElementById('products-loading').classList.add('hidden');
                document.getElementById('products-grid').classList.remove('hidden');
                
                const loadMoreSection = document.getElementById('load-more-section');
                if (hasNextPage) {
                    loadMoreSection.classList.remove('hidden');
                } else {
                    loadMoreSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products-loading').innerHTML = 
                    '<p class="error">Failed to load products. Please try again later.</p>';
            }
        }

        function displayProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';

            productsData.forEach(product => {
                const card = createProductCard(product);
                grid.appendChild(card);
            });
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const imageUrl = product.images.edges[0]?.node.url || 'https://via.placeholder.com/300x300/0a0a0a/e50000?text=No+Image';
            const price = formatPrice(
                product.priceRange.minVariantPrice.amount,
                product.priceRange.minVariantPrice.currencyCode
            );
            const isAvailable = product.variants.edges[0]?.node.availableForSale ?? true;

            card.innerHTML = `
                <div class="product-image">
                    <img src="${imageUrl}" alt="${product.title}">
                    ${!isAvailable ? '<div class="sold-out-badge">Sold Out</div>' : ''}
                </div>
                <div class="product-info">
                    <h3>${product.title}</h3>
                    <div class="product-price">${price}</div>
                    <button class="btn-view-product" onclick="viewProduct('${product.handle}')" ${!isAvailable ? 'disabled' : ''}>
                        ${isAvailable ? 'View Product' : 'Out of Stock'}
                    </button>
                </div>
            `;

            return card;
        }

        // Search functionality
        let searchTimeout;
        const searchInput = document.getElementById('product-search');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (e.target.value.trim().length >= 3) {
                    performSearch(e.target.value.trim());
                } else {
                    searchResults.classList.add('hidden');
                }
            }, 500);
        });

        searchBtn.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (query.length >= 3) {
                performSearch(query);
            }
        });

        async function performSearch(query) {
            try {
                searchResults.innerHTML = '<div class="search-loading"><div class="spinner-small"></div>Searching...</div>';
                searchResults.classList.remove('hidden');

                const data = await shopifyStorefrontAPI(SEARCH_QUERY, { query, first: 10 });
                const results = data.products.edges.map(edge => edge.node);

                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">No products found</div>';
                    return;
                }

                displaySearchResults(results);
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div class="search-error">Search failed. Please try again.</div>';
            }
        }

        function displaySearchResults(results) {
            searchResults.innerHTML = results.map(product => {
                const imageUrl = product.images.edges[0]?.node.url || '';
                const price = formatPrice(
                    product.priceRange.minVariantPrice.amount,
                    product.priceRange.minVariantPrice.currencyCode
                );

                return `
                    <div class="search-result-item" onclick="viewProduct('${product.handle}')">
                        ${imageUrl ? `<img src="${imageUrl}" alt="${product.title}">` : ''}
                        <div class="search-result-info">
                            <h4>${product.title}</h4>
                            <span class="search-result-price">${price}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View collection
        window.viewCollection = function(handle) {
            window.open(`https://${SHOPIFY_DOMAIN}/collections/${handle}`, '_blank');
        };

        // View product
        window.viewProduct = function(handle) {
            window.open(`https://${SHOPIFY_DOMAIN}/products/${handle}`, '_blank');
        };

        // Load more products
        document.getElementById('load-more-btn')?.addEventListener('click', () => {
            loadProducts(true);
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadCollections();
            loadProducts();
        });

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-section')) {
                searchResults.classList.add('hidden');
            }
        });
    </script>
</body>
</html>